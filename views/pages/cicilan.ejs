<!DOCTYPE html>
<html lang="en">

<head>
    <%- include('../partials/head'); %>
    <style>
        .menu-button {
<<<<<<< HEAD
            position: absolute;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            background-color: #258062;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            transition: 0.3s ease;
        }

        .logout-button {
            position: absolute;
            top: 20px;
            right: 120px;
            padding: 10px 20px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            transition: 0.3s ease;
        }
=======
        position: absolute;
        top: 20px;
        right: 57px;
        padding: 10px 20px;
        background-color: #258062;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        text-decoration: none;
        transition: 0.3s ease;
    }
        .logout-button {
        position: absolute;
        top: 20px;
        right: 180px;
        padding: 10px 20px;
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        text-decoration: none;
        transition: 0.3s ease;
    }
>>>>>>> b06551ebeb7400ba105f24f17fc841f16bc956ac
    </style>
</head>

<body>
    <div class="container mt-5">
        <h3>Pencatatan Cicilan</h3>

        <a href="/menu" class="menu-button"> <i class="fas fa-list"></i> Menu </a>
        <a href="/api/logout" class="logout-button">
            <i class="fas fa-sign-out-alt"></i> Logout
        </a>

        <!-- Form Input Cicilan -->
        <div class="card mb-4">
            <div class="card-header">
                Tambah Cicilan
            </div>
            <div class="card-body">
                <form id="cicilan-form">
                    <div class="row">
                        <div class="col-md-3">
                            <label for="name" class="form-label">Nama Cicilan</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>
                        <div class="col-md-3">
                            <label for="tenor" class="form-label">Tenor</label>
                            <input type="number" class="form-control" id="tenor" name="tenor" required>
                        </div>
                        <div class="col-md-3">
                            <label for="amount" class="form-label">Jumlah Cicilan per Bulan</label>
                            <input type="number" class="form-control" id="amount" name="amount" required>
                        </div>
                        <div class="col-md-3">
                            <label for="date" class="form-label">Tanggal Jatuh Tempo</label>
                            <input type="number" class="form-control" id="date" name="date" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary mt-3">Simpan</button>
                </form>
            </div>
        </div>

        <!-- Filter Data -->
        <div class="card mb-4">
            <div class="card-header">
                Filter Data
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <label for="filter-name" class="form-label">Nama Cicilan</label>
                        <input type="text" id="filter-name" class="form-control" placeholder="Masukkan Nama Cicilan">
                    </div>
                </div>
                <button type="button" class="btn btn-primary ms-2" onclick="filterData()">Cari</button>
                <button type="button" class="btn btn-secondary ms-2" onclick="resetFilter()">Reset</button>
            </div>
        </div>

        <!-- Tabel Daftar Cicilan -->
        <div class="card">
            <div class="card-header">
                Daftar Cicilan
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Nama Cicilan</th>
                                <th>Tenor</th>
                                <th>Jumlah Cicilan per Bulan</th>
                                <th>Tanggal Jatuh Tempo</th>
                                <th>Sisa Cicilan</th> <!-- Kolom baru untuk sisa cicilan -->
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="instalment-list">
                            <% instalments.forEach(instalment => { %>
                                <tr>
                                    <td><%= instalment.name %></td>
                                    <td><%= instalment.tenor %></td>
                                    <td><%= instalment.amount %></td>
                                    <td><%= instalment.date %></td>
                                    <td><%= instalment.tenor - instalment.paidCount %> kali</td> <!-- Menampilkan sisa cicilan -->
                                    <td>
                                        <button class="btn btn-warning btn-sm" onclick="editInstalment('<%= instalment._id %>')">Edit</button>
                                        <button class="btn btn-danger btn-sm" onclick="deleteInstalment('<%= instalment._id %>')">Hapus</button>
                                        <button class="btn btn-success btn-sm" onclick="markAsPaid('<%= instalment._id %>')">Bayar</button> <!-- Tombol bayar -->
                                    </td>
                                </tr>
                            <% }) %>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <%- include('../partials/footer.ejs'); %>
    </footer>

    <!-- JavaScript untuk Edit, Delete, Bayar, dan Filter -->
    <script>
        let currentId = '';

        // Fungsi untuk menambah cicilan
        document.getElementById('cicilan-form').addEventListener('submit', function(event) {
            event.preventDefault();

            const data = {
                name: document.getElementById('name').value,
                tenor: document.getElementById('tenor').value,
                amount: document.getElementById('amount').value,
                date: document.getElementById('date').value,
                paidCount: 0, // Inisialisasi paidCount untuk setiap cicilan baru
            };

            fetch('/api/instalment', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data),
            })
            .then(response => response.json())
            .then(() => {
                window.location.href = '/cicilan';  // Redirect ke halaman cicilan setelah submit
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });

        // Fungsi untuk menandai cicilan telah dibayar
        function markAsPaid(id) {
            fetch(`/api/instalment/${id}/pay`, {
                method: 'PUT',
            })
            .then(response => response.json())
            .then(data => {
                alert('Cicilan berhasil dibayar!');
                window.location.reload();  // Reload halaman untuk memperbarui sisa cicilan
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }

        // Fungsi untuk filter data berdasarkan nama
        function filterData() {
            const nameFilter = document.getElementById('filter-name').value.toLowerCase();
            const rows = document.querySelectorAll('#instalment-list tr');
            
            rows.forEach(row => {
                const nameCell = row.cells[0].textContent.toLowerCase();
                if (nameCell.includes(nameFilter)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }

        // Fungsi untuk mereset filter
        function resetFilter() {
            document.getElementById('filter-name').value = '';
            filterData(); // Menampilkan data setelah filter direset
        }

        // Edit dan Delete cicilan tetap sama.
        function editInstalment(id) {
            currentId = id;
            fetch(`/api/instalment/${id}`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('edit-id').value = data.instalment._id;
                    document.getElementById('edit-name').value = data.instalment.name;
                    document.getElementById('edit-tenor').value = data.instalment.tenor;
                    document.getElementById('edit-amount').value = data.instalment.amount;
                    document.getElementById('edit-date').value = data.instalment.date.split('T')[0];

                    new bootstrap.Modal(document.getElementById('editModal')).show();
                });
        }

        function deleteInstalment(id) {
            if (confirm('Apakah Anda yakin ingin menghapus data ini?')) {
                fetch(`/api/instalment/${id}`, {
                    method: 'DELETE'
                })
                .then(() => {
                    alert('Cicilan berhasil dihapus!');
                    window.location.reload();
                });
            }
        }
    </script>
</body>

</html>
